<div style="display: flex; flex-wrap: nowrap; align-items: center; justify-content: space-between;">
  <img src="https://github.com/transover/sEMG-MMG_SYNC/blob/main/en/SchematicDiagram_SignalAcquisition.svg" alt="SchematicDiagram_SignalAcquisition" style="height: 350px; max-width: 45%; object-fit: contain;">
  <img src="https://github.com/transover/sEMG-MMG_SYNC/blob/main/en/NITaskArchitecture.svg" alt="NITaskArchitecture" style="height: 350px; max-width: 45%; object-fit: contain;">
</div>

<p align="center">
  English
  ｜
  <a href="https://github.com/transover/sEMG-MMG_SYNC/blob/main/en/README.md">简体中文</a>
</p>

# Instructions for Use
Synchronous acquisition and analysis for sEMG-MMG. **NI9205** and **TCP/IP** were used to collect data generated by **Quspin** and **BioSemi**.
- Analog data acquisition of **QuSpin** (OPMs device), **BioSemi** (sEMG/ECG device), **CIYENIC** (muscle force device) and other devices is performed through the **cDAQ** unit of National Instruments. This interface leads to multiple data streams of different devices, multi-threaded synchronous execution, the core technology around **NI-DAQmx**, **PsychToolBox/PsychoPy** and **TCP/IP** protocols. **NI-DAQmx** is based on the ctypes library and is a complex, highly object-oriented wrapper for developing **C API** implementations. The **Serial/Parallel** protocol controls and records stimulus levels via a serial port or parallel port (**LPT** driver required, **InpOut32/64** is an open source Windows **DLL** and driver for direct access to hardware ports). **PsychoPy** is based on the underlying controls of the **PsychToolBox**, combining the graphics rendering benefits of OpenGL with syntax to provide stimulus presentation and control, with asynchronous high-precision planned timing, for cognitive neuroscience and experimental psychology research. **TCP/IP** protocol wirelessly obtains real-time sensor information through data stream interception.
- When the connection state, display state, acquisition state, and stimulus indicator light are all on, click to start recording data and click Pause to end recording, and the data will be automatically saved as 3 independent files. You can download the **UI_Collector.exe** tool in <a href="https://github.com/transover/sEMG-MMG_SYNC/releases/UI_Collector">Release</a> for the task of sEMG-MMG acquisition, as shown in the following figure:

<div style="display: flex; flex-wrap: nowrap; align-items: center; gap: 5%; overflow: hidden;">
  <img src="https://github.com/transover/sEMG-MMG_SYNC/blob/main/ExampleData/SignalAcquisition.gif" alt="SignalAcquisition" style="height: 300px; width: auto; max-width: 45%; object-fit: scale-down;">
  <img src="https://github.com/transover/sEMG-MMG_SYNC/blob/main/ExampleData/SignalPlot.jpg" alt="SiganlPlotWindow" style="height: 300px; width: auto; max-width: 45%; object-fit: scale-down;">
</div>

### 1. Using the NI9205 Acquisition Board and Installing the NI Driver:
- In the `NI-DAQmx_driver` directory, run `ni-daqmx_24.0_online.exe` and select the default installation settings.

### 2. Using the BioSemi Acquisition Device and Installing the TCP/IP Server:
- Download `ACTIVIEW806` from the `BioSemi` directory and use it directly. If LabView files are missing, install `LabView RuntimeEngine 2016 (64bit)/setup.exe`.
- Run the batch file in the `BioSemi` directory to launch `ActView806-Lores.exe`, and select the configuration file `ACTIVIEW806/Configuring/sEMG_A32_Config.cfg`.
- Set the TCP Server local port to `8888`, and choose TCP subset `A1~A32 (32)`.

### 3. Completing TCP/IP Connection and Viewing Acquisition Changes on ActView806 by Selecting A1~A32 After Successful Connection:
#### Steps:
        1. When the user starts collecting data, the server's TCP Listening round icon turns green, indicating that Biosemi ActiveTwo is listening and ready to establish a connection.
        2. After the user runs the client function and connects successfully, the TCP Connected circular icon in Biosemi ActiveTwo will turn green, indicating that Biosemi is transmitting data to the client.
        3. Read data (Once the connection is established, parameters are disabled and can only be modified after the connection is terminated. The number of bytes received and transmitted is also reported in Biosemi ActiveTwo.)

#### Notes:
        1. Users must ensure that the TCP/IP function parameters in the client match those set in Biosemi ActiveTwo.
        2. Note that since Biosemi ActiveTwo acts as a server, a connection cannot be established unless Biosemi ActiveTwo is running in display or recording mode.
        3. Parameters in Biosemi ActiveTwo are located on the TCP Server tab and must be adjusted before running Biosemi ActiveTwo. Once Biosemi ActiveTwo starts data acquisition, even in display mode, parameters cannot be changed.
        4. Be careful to select the number of channels; otherwise, even if the connection is successful, data cannot be read.
        5. Streaming through TCP/IP introduces several hundred milliseconds of delay and tens of milliseconds of jitter. Data streamed via TCP/IP cannot be used directly for precise timing and requires buffering.
        ![Data Transfer Protocol-24bit](https://github.com/user-attachments/assets/20d02826-d712-421e-8cf5-1f521aea045d)

#### Parameters (TCP/IP parameters used for connecting with Biosemi):
        •IP address (host):
            If running on the same machine as Biosemi ActiveTwo, set it to 127.0.0.1. Otherwise, use the IP address of the machine running Biosemi ActiveTwo.
        •Port (port):
            The port used for communication. It must match the port reported by the TCP server in Biosemi ActiveTwo. The default value is 8888.
        •Samples per packet (tcpsamples):
            This defines the number of sample points included in each packet sent by Biosemi ActiveTwo. It depends on the sampling rate chosen by the user.
        •Bytes per sample (bytes):
            This defines the number of bytes used to represent each sample. It is fixed regardless of the sampling rate and cannot be changed by the user.
        •Channels + triggers (channels):
            This shows the number of selected channels (plus triggers). It is controlled by the channels setting, which will be described later in the parameters section dedicated to EEG data (section: Biosemi parameters).
            This value must match the one reported by Biosemi ActiveTwo.

### 4. Launch UI_Collector and Follow Help Instructions to Complete Data Acquisition
1.  Launch the software. If the NI9205 is connected properly, the **[Connection Status]** indicator will light up; otherwise, an error message will pop up.
2.  Check **[Enable EMG]** to light up the **[EMG]** indicator.
3.  Enter the stimulus information and click **[STI On]**. An experiment paradigm prompt will appear; click **[OK]** to light up the **[Stimulus]** indicator.
4.  Click **[Record]** to light up the **[Acquisition Status]** indicator, indicating that data streams are being written to file in real time (to accurately record timestamps, you must click **[Record]** to enter recording mode before clicking **[Start]**).
5.  Click **[Start]** to light up the **[Display Status]** indicator, indicating that the NI task is active and data collection and display have started (if **[Record]** is not clicked, data will be previewed but not saved).
6.  Click **[Stop]** to turn off both **[Display Status]** and **[Acquisition Status]** indicators, indicating that the acquisition or preview task is paused (in stimulus presentation mode, **[Start]** cannot be clicked again).
7.  Click **[Close]** to turn off all indicators, indicating that the task has ended. To start a new acquisition, the software must be restarted.
8.  Click **[Save]** (not needed in recording mode) to save partial data from the graph into a custom file (Note: it is not recommended for saving all data, as real-time data can be saved automatically. Long-term recording with this method requires a large amount of memory).
9.  Click the toolbar **[Export (PDF)]** to export experimental information as a PDF file.
10. Click the toolbar **[View Timing]** to view timing information and compare the start and end times and delays of different modalities.
11. Click the toolbar **[Plot Image]** to plot high-resolution images and preview collected data.
12. Check **[Enable Filter]** to filter real-time images without affecting the written data.
13. Check **[Enable Unit]** to switch data units for real-time images and automatically convert values (configurable in **[Tab Config]** under channel modality settings).
14. Click **[Choose CH]** to switch the displayed channels.
15. The control bar widgets allow play, pause, global view, zoom, and removal control of real-time images.
16. Hover the mouse over any button to view its function information.

### 5. If Parallel Port Triggering is Needed, Follow Help Instructions to Configure Additional Driver Files
![Example of signal acquisition process](https://github.com/user-attachments/assets/cb5fd44a-fc6f-4f79-b5d3-36074266ab10)

------------------------------------------------------------------------------------------------------------------------------------------------------------------
